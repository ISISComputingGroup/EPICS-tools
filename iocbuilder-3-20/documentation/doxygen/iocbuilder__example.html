<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>iocbuilder: Creating an example IOC using \c iocbuilder</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.2 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">iocbuilder Python Module</a>
  </div>
</div>
<div class="contents">
<p>This page will walk through creating a simple IOC using the iocbuilder</p>
<h2><a class="anchor" id="pre">
Prerequisites</a></h2>
<ul>
<li>Run the <code>dls-make-etc-dir.py</code> script to create an <code>etc</code> directory.</li>
</ul>
<h2><a class="anchor" id="dir">
Directory structure</a></h2>
<ul>
<li><code>&lt;module&gt;/etc/makeIocs/&lt;iocname&gt;_RELEASE</code> is an optional file that specifies module dependencies that are not captured in <code>&lt;module&gt;/configure/RELEASE</code> </li>
<li><code>&lt;module&gt;/etc/makeIocs/&lt;iocname&gt;.py</code> is the script that will be run by make. It will be passed <code>iocname</code> as an argument, and should create <code>&lt;module&gt;/iocs/&lt;iocname&gt;</code> </li>
</ul>
<h2><a class="anchor" id="ex">
Example</a></h2>
<p>Following the steps below will create a simple IOC with a single instance of a eurotherm2k controller. If you want to try this out for yourself you can copy <code>example_ioc.py</code> and <code>example_ioc_RELEASE</code> from <code>&lt;iocbuilder&gt;/documentation/examples/</code> to <code>&lt;module&gt;/etc/makeIocs/</code> Typing <code>make</code> in the <code>&lt;module&gt;/etc/makeIocs/</code> directory will create an IOC <code>example_ioc</code> in <code>&lt;module&gt;/iocs/example_ioc</code> </p>
<h3><a class="anchor" id="ex1">
&lt;iocname&gt;_RELEASE</a></h3>
<p>The following text is from <code>&lt;iocbuilder&gt;/documentation/examples/example_ioc_RELEASE</code> </p>
<div class="fragment"><pre class="fragment">SUPPORT=/dls_sw/prod/R3.14.8.2/support
WORK=/dls_sw/work/R3.14.8.2/support

<span class="preprocessor"># Place any example specific dependencies here</span>
<span class="preprocessor"></span>PYDRV=          $(SUPPORT)/pyDrv/1-2
STREAMDEVICE=   $(SUPPORT)/streamDevice/2-4dls2-1
EUROTHERM2K=    $(WORK)/eurotherm2k
</pre></div><p> This is just a standard RELEASE file that lists paths to other modules. The iocbuilder will walk the tree of <code>&lt;module&gt;/configure/RELEASE</code> and <code>&lt;iocname&gt;_RELEASE</code> if it exists, and import the relevant builder files from these modules in depth first order (i.e. all dependencies of a module before the module itself).</p>
<h3><a class="anchor" id="ex2">
&lt;iocname&gt;.py</a></h3>
<p>The following text is from <code>&lt;iocbuilder&gt;/documentation/examples/example_ioc</code>.py </p>
<div class="fragment"><pre class="fragment"><span class="comment">#!/bin/env dls-python2.4</span>

<span class="comment"># setup the path</span>
<span class="keyword">from</span> pkg_resources <span class="keyword">import</span> require
require(<span class="stringliteral">&quot;dls_dependency_tree&quot;</span>)
require(<span class="stringliteral">&quot;iocbuilder&quot;</span>)

<span class="comment"># import modules</span>
<span class="keyword">import</span> iocbuilder
<span class="keyword">from</span> dls_dependency_tree <span class="keyword">import</span> dependency_tree

<span class="comment"># parse the options supplied to the program</span>
options, args = iocbuilder.ParseEtcArgs(architecture=<span class="stringliteral">&quot;linux-x86&quot;</span>)
iocbuilder.ParseAndConfigure(options, dependency_tree)

<span class="comment"># import the builder objects</span>
<span class="keyword">from</span> iocbuilder.modules <span class="keyword">import</span> *

<span class="comment"># make some objects</span>
<span class="keywordflow">if</span> options.debug:
    <span class="keywordflow">print</span> <span class="stringliteral">&quot;Creating builder objects...&quot;</span>
eurothermSim = pyDrv.serial_sim_instance(
    name=<span class="stringliteral">&#39;eurothermSim&#39;</span>, pyCls=<span class="stringliteral">&#39;eurotherm2k&#39;</span>, module=<span class="stringliteral">&#39;eurotherm2k_sim&#39;</span>,
    IPPort=8100, rpc=9001)
asyn.AsynIP(
    name=<span class="stringliteral">&#39;eurothermAsyn&#39;</span>, port=<span class="stringliteral">&#39;172.23.111.180:7001&#39;</span>, simulation=eurothermSim)
eurotherm2k.eurotherm2k(
    P=<span class="stringliteral">&#39;EUROTHERM2K&#39;</span>, Q=<span class="stringliteral">&#39;&#39;</span>, PORT=<span class="stringliteral">&#39;eurothermAsyn&#39;</span>, GAD=0, LAD=1)
<span class="keywordflow">if</span> options.debug:
    <span class="keywordflow">print</span> <span class="stringliteral">&quot;Done&quot;</span>

<span class="comment"># write the IOC</span>
iocbuilder.WriteNamedIoc(options.iocpath, options.iocname, substitute_boot=<span class="keyword">True</span>)
</pre></div><p> We will now walk through this example line by line</p>
 <div class="fragment"><pre class="fragment">from pkg_resources <span class="keyword">import</span> require
require(<span class="stringliteral">&quot;dls_dependency_tree&quot;</span>)
require(&quot;iocbuilder&quot;)
</pre></div> First we setup the path.</p>
<ul>
<li>If we are using a released version of the iocbuilder, then all we need to do is tell setuptools to pick the latest version with a call to <code>require</code>. We can also tell setuptools to use a particular version by typing: <div class="fragment"><pre class="fragment">require(<span class="stringliteral">&#39;iocbuilder==2.3&#39;</span>)
</pre></div></li>
<li>If we are using the development version of iocbuilder, we need to point directly to it instead of the <code>require</code> call. This should only be used for testing: <div class="fragment"><pre class="fragment"><span class="keyword">import</span> sys
sys.path.append(<span class="stringliteral">&#39;/home/mga83/epics/iocbuilder&#39;</span>)
</pre></div></li>
</ul>
<p><b>Note</b> that we also need to <code>require</code>('dls_dependency_tree') if we want iocbuilder to walk any <code>RELEASE</code> files for us. <br/>
<br/>
 <div class="fragment"><pre class="fragment"><span class="keyword">import</span> iocbuilder
from dls_dependency_tree <span class="keyword">import</span> dependency_tree
</pre></div> Now we do the imports. Note that the iocbuilder needs to be configured before much of its namespace is available, so we just import iocbuilder here. <br/>
<br/>
 <div class="fragment"><pre class="fragment">options, args = iocbuilder.ParseEtcArgs(architecture=<span class="stringliteral">&quot;linux-x86&quot;</span>)
</pre></div> This is where iocbuilder is configured.</p>
<ul>
<li>If we pass a dependency_tree module to ParseEtcArgs() then it will parse the RELEASE tree for us. If we don't pass it one, then we will need to do ModuleVersion() calls manually, e.g.: <div class="fragment"><pre class="fragment">ModuleVersion(<span class="stringliteral">&#39;ipac&#39;</span>,           <span class="stringliteral">&#39;2-8dls4-3&#39;</span>)
ModuleVersion(&#39;Hy8515&#39;,         &#39;3-7&#39;)
</pre></div></li>
<li>The second argument is the architecture the ioc will be built with, it defaults to <code>vxWorks-ppc604_long</code>.</li>
</ul>
<p>See the ParseEtcArgs() documentation for more details of what the function does. If it doesn't do what you want, you can dispense with it and call <a class="el" href="classiocbuilder_1_1configure_1_1Configure.html">Configure</a> directly.</p>
<p><b>Note</b> that if we run the script with a -h flag we get details of what arguments to pass:</p>
<ul>
<li><div class="fragment"><pre class="fragment">[tmc43@pc0043 makeIocs]$$ ./example_ioc.py -h
usage: example_ioc.py [options] &lt;ioc_name&gt;

This program will configure iocbuilder to write an ioc structure. It should
be run from the etc/makeIocs directory, and will create iocs/&lt;ioc_name&gt;

options:
  -h, --help     show <span class="keyword">this</span> help message and exit
  -d             Print lots of debug information
  --sim=SIMARCH  Create an ioc with arch=SIMARCH in simulation mode
</pre></div></li>
</ul>
<p><br/>
 <div class="fragment"><pre class="fragment">from iocbuilder.modules <span class="keyword">import</span> *
</pre></div> As iocbuilder is configured, and more support modules are added, it populates its modules namespace. Doing this import line will let us refer to builder classes as <code>&lt;module&gt;.&lt;classname&gt;</code>. <br/>
<br/>
 <div class="fragment"><pre class="fragment"><span class="keywordflow">if</span> options.debug:
    print <span class="stringliteral">&quot;Creating builder objects...&quot;</span>
</pre></div> As described in the ParseEtcArgs() documentation, the <code>options</code> object lets us access the commandline arguments, if you want to print debug information you should check the value of <code>options.debug</code> first. <br/>
<br/>
 <div class="fragment"><pre class="fragment">eurothermSim = pyDrv.serial_sim_instance(
    name=<span class="stringliteral">&#39;eurothermSim&#39;</span>, pyCls=<span class="stringliteral">&#39;eurotherm2k&#39;</span>, module=<span class="stringliteral">&#39;eurotherm2k_sim&#39;</span>,
    IPPort=8100, rpc=9001)
</pre></div> This instantiates a serial_sim instance that will be created when this script is run in simulation mode. This simulation is configured to run over serial or IP depending on the type of asyn port (serial or IP) that it is linked to. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>This is the name of the serial_sim object that will be created in the startup script </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pyCls</em>&nbsp;</td><td>This is the serial_sim subclass that should be instantiated </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>module</em>&nbsp;</td><td>This is the python module to import pyCls from </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>IPPort</em>&nbsp;</td><td>By default the IP port will be chosen automatically, if you need to specify one, do it here </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>rpc</em>&nbsp;</td><td>This is the port to run the rpc (back door) over</td></tr>
  </table>
  </dd>
</dl>
<p><br/>
 <div class="fragment"><pre class="fragment">asyn.AsynIP(
    name=<span class="stringliteral">&#39;eurothermAsyn&#39;</span>, port=<span class="stringliteral">&#39;172.23.111.180:7001&#39;</span>, simulation=eurothermSim)
</pre></div> This instantiates an asyn IP port. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>Name or the asyn port </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>port</em>&nbsp;</td><td>The port to connect to in the real IOC </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>simulation</em>&nbsp;</td><td>The serial_sim object to connect to when run in simulation mode</td></tr>
  </table>
  </dd>
</dl>
<p><br/>
 <div class="fragment"><pre class="fragment">eurotherm2k.eurotherm2k(
    P=<span class="stringliteral">&#39;EUROTHERM2K&#39;</span>, Q=<span class="stringliteral">&#39;&#39;</span>, PORT=<span class="stringliteral">&#39;eurothermAsyn&#39;</span>, GAD=0, LAD=1)
</pre></div> This instantiates a eurotherm2k controller. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>P</em>&nbsp;</td><td>Device prefix </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>Q</em>&nbsp;</td><td>Device suffix </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>PORT</em>&nbsp;</td><td>Name of the asyn port to communicate over </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>GAD</em>&nbsp;</td><td>Global address number set on the controller </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>LAD</em>&nbsp;</td><td>Local address number set on the controller</td></tr>
  </table>
  </dd>
</dl>
<p><br/>
 <div class="fragment"><pre class="fragment">iocbuilder.WriteNamedIoc(options.iocpath, options.iocname, substitute_boot=True)
</pre></div> Finally write the ioc out. At this point all work with IOC builder is complete, and the builder application should exit.</p>
<h2><a class="anchor" id="Notes">
Notes</a></h2>
<p>Eventually a page called builder_objects will be generated in the documentation for that module. This will contain information about all the arguments that should be supplied to the relevant builder objects. For now it is recommended that you use the xmlbuilder module to create simple test IOCs as documented in: <a class="el" href="using__xmlbuilder.html">Creating an IOC using the xml front end</a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.2 </small></address>
</body>
</html>
